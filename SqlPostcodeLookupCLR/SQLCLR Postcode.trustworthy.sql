SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;
SET NUMERIC_ROUNDABORT OFF;
GO
/*
Ensure that CLR is enabled within the SQL server instance

Only set trustworthy on in a development environment to test the functionality.
*/

USE master
ALTER DATABASE MyDb SET TRUSTWORTHY ON
GRANT EXTERNAL ACCESS ASSEMBLY TO [TheDatabaseOwnerUsername]
GO

USE MyDb
GO
CREATE ASSEMBLY [SQLCLR_Postcode_Lookup]
	AUTHORIZATION [dbo]
    FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030044D91D540000000000000000E00002210B010B000010000000060000000000004E2E0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000FC2D00004F00000000400000E002000000000000000000000000000000000000006000000C000000C42C00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000540E0000002000000010000000020000000000000000000000000000200000602E72737263000000E0020000004000000004000000120000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001600000000000000000000000000004000004200000000000000000000000000000000302E00000000000048000000020005006C220000580A000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B3002009D0000000100001100730600000A0A0072010000700F00FE16030000016F0700000A280800000A280900000A75100000010B076F0A00000A75120000010C00730B00000A0D09086F0C00000A6F0D00000A0006096F0E00000A0000DE120814FE01130611062D07086F0F00000A00DC0000DE2913040003281000000A16FE01130611062D040011047A00730B00000A0D06096F0E00000A000000DE00000613052B0011052A000000011C0000020036001F5500120000000000000700646B0029150000011330030040010000020000110002740D0000010A030672530000706F1100000A2C120672530000706F1100000A6F1200000A2B05727500007000281300000A8103000001040672850000706F1100000A2C1C0672850000706F1100000A6F1200000A281400000A281500000A2B057E1600000A008105000001050672A50000706F1100000A2C1C0672A50000706F1100000A6F1200000A281400000A281500000A2B057E1600000A0081050000010E040672C50000706F1100000A2C1C0672C50000706F1100000A6F1200000A281400000A281500000A2B057E1600000A0081050000010E050672ED0000706F1100000A2C1C0672ED0000706F1100000A6F1200000A281400000A281500000A2B057E1600000A0081050000010E060672170100706F1100000A2C170672170100706F1100000A6F1200000A281300000A2B057E1700000A0081030000012A1E02281800000A2A42534A4201000100000000000C00000076342E302E33303331390000000005006C00000070020000237E0000DC0200006C03000023537472696E6773000000004806000040010000235553008807000010000000234755494400000098070000C002000023426C6F620000000000000002000001471502080900000000FA253300160000010000001800000002000000030000000900000018000000040000000200000001000000010000000400000000000A0001000000000006004A0043000600640051000A0091007C000A009B007C000A00B5007C0006000A01EB000600560143011F006A0100000600990179010600B90179010A000902EE01060039021E020E004B024002060060024300120079026E0212008B026E0212009A026E021200B2026E020600CC02C2020600EE02430006000E0343000E001803400206004B034300060053034300000000000100000000000100010001001000250000000500010001005020000000009600A6000A0001001821000000009600C000130003006422000000008618C8002A000A0000000100CE0000000200D70000000100E70002000200CE00020003001701020004002001020005002A01020006003201020007003B013100C8002A003900C8002E004900C80034005100C8002A005900C8002A000C00C8002A00090057022602710067022A027900840230027900A60236026900C8002A008900D3023B026900E50240020C00EA024602A100FA022A00210002034C02B10020036602B1003103260219003F036C02B9005B03720229003F037802290065037F021900650383020900C8002A0020002B0039002E0013008C022E001B0095022E0023009E02520287021F02048000000000000000000000000000000000D701000004000000000000000000000001003A00000000000400000000000000000000000100700000000000040000000000000000000000010040020000000004000000000000000000000001004300000000000000003C4D6F64756C653E0053514C434C525F506F7374636F64655F4C6F6F6B75702E646C6C0055736572446566696E656446756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E730049456E756D657261626C650053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E670053716C426F6F6C65616E004C6F6F6B7570506F7374636F64650053716C446563696D616C0066696C6C726F77002E63746F7200506F7374636F6465005468726F77457863657074696F6E73006F626A0053797374656D2E52756E74696D652E496E7465726F705365727669636573004F7574417474726962757465004C61746974756465004C6F6E6769747564650045617374696E67004E6F727468696E670047656F686173680053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053514C434C525F506F7374636F64655F4C6F6F6B7570004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E4174747269627574650053797374656D2E436F6C6C656374696F6E732E47656E65726963004C69737460310053797374656D2E586D6C00586D6C446F63756D656E7400546F537472696E6700537472696E6700466F726D61740053797374656D2E4E657400576562526571756573740043726561746500487474705765625265717565737400576562526573706F6E736500476574526573706F6E73650048747470576562526573706F6E73650053797374656D2E494F0053747265616D00476574526573706F6E736553747265616D004C6F6164004164640049446973706F7361626C6500446973706F7365006F705F4578706C6963697400457863657074696F6E00586D6C4E6F64650053656C65637453696E676C654E6F6465006765745F496E6E657254657874006F705F496D706C6963697400436F6E7665727400446563696D616C00546F446563696D616C004E756C6C000000005168007400740070003A002F002F0075006B002D0070006F007300740063006F006400650073002E0063006F006D002F0070006F007300740063006F00640065002F007B0030007D002E0078006D006C0001212F0072006500730075006C0074002F0070006F007300740063006F0064006500000F55006E006B006E006F0077006E00001F2F0072006500730075006C0074002F00670065006F002F006C0061007400001F2F0072006500730075006C0074002F00670065006F002F006C006E00670000272F0072006500730075006C0074002F00670065006F002F00650061007300740069006E00670000292F0072006500730075006C0074002F00670065006F002F006E006F0072007400680069006E00670000272F0072006500730075006C0074002F00670065006F002F00670065006F0068006100730068000000630808DB22A6714DA5A329B538AF9E340008B77A5C561934E0890800021209110D1111160007011C10110D10111510111510111510111510110D03200001052001011121042001010881E4010004005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054557F4D6963726F736F66742E53716C5365727665722E5365727665722E53797374656D446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038391053797374656D4461746141636365737300000000540E1146696C6C526F774D6574686F644E616D650766696C6C726F77540E0F5461626C65446566696E6974696F6E808E506F7374636F6465206E766172636861722839292C204C6174697475646520646563696D616C2831382C203135292C204C6F6E67697475646520646563696D616C2831382C3135292C2045617374696E6720646563696D616C2831302C31292C204E6F727468696E6720646563696D616C2831302C31292C2047656F68617368206E766172636861722832303029061512310112350320000E0500020E0E1C050001123D0E0420001245042000124D05200101124D052001011300050001021111130707151231011235124112491235125512090205200112590E050001110D0E05000111610E06000111151161030611150306110D04070112350801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000000000000044D91D5400000000020000001C010000E02C0000E00E0000525344536676C9FE2F0DCB429A005195EC88928905000000633A5C4F6E6544726976655C56697375616C2053747564696F20323031325C50726F6A656374735C53514C434C5220506F7374636F6465204C6F6F6B75705C53514C434C5220506F7374636F6465204C6F6F6B75705C6F626A5C44656275675C53514C434C525F506F7374636F64655F4C6F6F6B75702E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000242E000000000000000000003E2E0000002000000000000000000000000000000000000000000000302E0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000840200000000000000000000840234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004E4010000010053007400720069006E006700460069006C00650049006E0066006F000000C001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000058001B00010049006E007400650072006E0061006C004E0061006D0065000000530051004C0043004C0052005F0050006F007300740063006F00640065005F004C006F006F006B00750070002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000060001B0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530051004C0043004C0052005F0050006F007300740063006F00640065005F004C006F006F006B00750070002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000503E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
	WITH PERMISSION_SET = EXTERNAL_ACCESS;
GO
CREATE FUNCTION [dbo].[LookupPostcode]
(@Postcode NVARCHAR (4000), @ThrowExceptions BIT)
RETURNS 
     TABLE (
        [Postcode]  NVARCHAR (9)     NULL,
        [Latitude]  DECIMAL (18, 15) NULL,
        [Longitude] DECIMAL (18, 15) NULL,
        [Easting]   DECIMAL (10, 1)  NULL,
        [Northing]  DECIMAL (10, 1)  NULL,
        [Geohash]   NVARCHAR (200)   NULL)
AS
EXTERNAL NAME [SQLCLR_Postcode_Lookup].[UserDefinedFunctions].[LookupPostcode]

GO

SELECT * FROM dbo.LookupPostcode('RG6 1WG', 1)
